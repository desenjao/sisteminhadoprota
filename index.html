<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protinha Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .error { color: red; }
        .success { color: green; }
        .loading::after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' ....'; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <h1 class="text-3xl font-bold text-center mb-6">Protinha Dashboard</h1>

        <!-- System Status -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Status do Sistema</h2>
            <p id="status" class="text-gray-700">Carregando...</p>
        </div>

        <!-- Create Objective Form -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Criar Novo Objetivo</h2>
            <form id="objectiveForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nome do Objetivo</label>
                    <input type="text" id="nome" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="categoria" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="trabalho">Trabalho</option>
                        <option value="corpo">Corpo</option>
                        <option value="mente">Mente</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Prioridade</label>
                    <select id="prioridade" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="alta">Alta</option>
                        <option value="media">M√©dia</option>
                        <option value="baixa">Baixa</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Meta Final (Opcional)</label>
                    <input type="text" id="meta_final" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Motiva√ß√£o (Opcional)</label>
                    <textarea id="motivacao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Criar Objetivo</button>
            </form>
            <p id="objectiveMessage" class="mt-2"></p>
        </div>

        <!-- Dashboard -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Dashboard</h2>
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <p>Carregando...</p>
            </div>
        </div>

        <!-- Objectives List -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Objetivos</h2>
            <div id="objectivesList" class="space-y-4">
                <p>Carregando...</p>
            </div>
        </div>

        <!-- Missions List -->
        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-2">Miss√µes</h2>
            <div id="missionsList" class="space-y-4">
                <p>Selecione um objetivo para ver suas miss√µes.</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';

        // Helper function for API requests
        async function fetchAPI(endpoint, method = 'GET', data = null) {
            try {
                const config = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (data) config.body = JSON.stringify(data);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const result = await response.json();
                if (!response.ok) throw new Error(result.erro || 'Erro na requisi√ß√£o');
                return result;
            } catch (error) {
                throw error;
            }
        }

        // Load system status
        async function loadStatus() {
            const statusEl = document.getElementById('status');
            try {
                statusEl.textContent = 'Carregando...';
                statusEl.classList.add('loading');
                const data = await fetchAPI('/');
                statusEl.textContent = `${data.sistema} - Status: ${data.status} - IA: ${data.ia}`;
                statusEl.classList.remove('loading');
            } catch (error) {
                statusEl.textContent = `Erro: ${error.message}`;
                statusEl.classList.add('error');
            }
        }

        // Load dashboard
        async function loadDashboard() {
            const dashboardEl = document.getElementById('dashboard');
            try {
                dashboardEl.innerHTML = '<p class="loading">Carregando...</p>';
                const data = await fetchAPI('/dashboard');
                dashboardEl.innerHTML = `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium">Total de Objetivos</h3>
                        <p class="text-2xl">${data.resumo.total_objetivos}</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium">Miss√µes Pendentes</h3>
                        <p class="text-2xl">${data.resumo.missoes_pendentes}</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium">Progresso Geral</h3>
                        <p class="text-2xl">${data.resumo.progresso_geral}%</p>
                    </div>
                `;
            } catch (error) {
                dashboardEl.innerHTML = `<p class="error">Erro: ${error.message}</p>`;
            }
        }

        // Load objectives
        async function loadObjectives() {
            const objectivesListEl = document.getElementById('objectivesList');
            try {
                objectivesListEl.innerHTML = '<p class="loading">Carregando...</p>';
                const data = await fetchAPI('/objetivos');
                objectivesListEl.innerHTML = data.objetivos.map(obj => `
                    <div class="p-4 bg-gray-50 rounded-lg flex justify-between items-center">
                        <div>
                            <h3 class="font-medium">${obj.nome}</h3>
                            <p class="text-sm text-gray-600">Categoria: ${obj.categoria} | Prioridade: ${obj.prioridade} | Progresso: ${obj.progresso}%</p>
                            <p class="text-sm text-gray-600">${obj.meta_final ? `Meta: ${obj.meta_final}` : ''}</p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="loadMissions(${obj.id})" class="bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600">Ver Miss√µes</button>
                            <button onclick="deleteObjective(${obj.id})" class="bg-red-500 text-white py-1 px-3 rounded hover:bg-red-600">Excluir</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                objectivesListEl.innerHTML = `<p class="error">Erro: ${error.message}</p>`;
            }
        }

        // Load missions for a specific objective
        async function loadMissions(objetivoId) {
            const missionsListEl = document.getElementById('missionsList');
            try {
                missionsListEl.innerHTML = '<p class="loading">Carregando...</p>';
                const data = await fetchAPI(`/missoes?objetivoId=${objetivoId}`);
                missionsListEl.innerHTML = data.missoes.length > 0 ? data.missoes.map(missao => `
                    <div class="p-4 bg-gray-50 rounded-lg flex justify-between items-center">
                        <div>
                            <h3 class="font-medium ${missao.status === 'concluida' ? 'line-through' : ''}">${missao.titulo}</h3>
                            <p class="text-sm text-gray-600">${missao.descricao}</p>
                            <p class="text-sm text-gray-600">Prioridade: ${missao.prioridade} | Pontos: ${missao.pontos} | IA: ${missao.gerado_por_ia ? 'Sim üß†' : 'N√£o'}</p>
                        </div>
                        ${missao.status === 'pendente' ? `
                            <button onclick="completeMission(${missao.id})" class="bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600">Concluir</button>
                        ` : '<span class="text-green-600">Conclu√≠da</span>'}
                    </div>
                `).join('') : '<p>Nenhuma miss√£o encontrada para este objetivo.</p>';
            } catch (error) {
                missionsListEl.innerHTML = `<p class="error">Erro: ${error.message}</p>`;
            }
        }

        // Create new objective
        document.getElementById('objectiveForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('objectiveMessage');
            try {
                messageEl.textContent = 'Criando...';
                messageEl.classList.add('loading');
                const data = {
                    nome: document.getElementById('nome').value,
                    categoria: document.getElementById('categoria').value,
                    prioridade: document.getElementById('prioridade').value,
                    meta_final: document.getElementById('meta_final').value,
                    motivacao: document.getElementById('motivacao').value,
                };
                const result = await fetchAPI('/objetivos', 'POST', data);
                messageEl.textContent = result.mensagem;
                messageEl.classList.add('success');
                document.getElementById('objectiveForm').reset();
                loadObjectives();
                loadDashboard();
            } catch (error) {
                messageEl.textContent = `Erro: ${error.message}`;
                messageEl.classList.add('error');
            } finally {
                messageEl.classList.remove('loading');
            }
        });

        // Delete objective
        async function deleteObjective(id) {
            if (!confirm('Tem certeza que deseja excluir este objetivo?')) return;
            try {
                const result = await fetchAPI(`/objetivos/${id}`, 'DELETE');
                alert(result.mensagem);
                loadObjectives();
                loadDashboard();
                document.getElementById('missionsList').innerHTML = '<p>Selecione um objetivo para ver suas miss√µes.</p>';
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        // Complete mission
        async function completeMission(id) {
            try {
                const result = await fetchAPI(`/missoes/${id}/concluir`, 'POST');
                alert(result.mensagem);
                loadObjectives();
                loadDashboard();
                const objetivoId = result.missao?.objetivoId || document.getElementById('missionsList').dataset.objetivoId;
                if (objetivoId) loadMissions(objetivoId);
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        // Initial load
        loadStatus();
        loadDashboard();
        loadObjectives();
    </script>
</body>
</html>